controller:
  # Disable internal HTTPS (handled by Ingress)
  httpsKeyStore:
    enable: false
  ingress:
    enabled: true
    apiVersion: "networking.k8s.io/v1"
    hostName: jenkins.34.55.201.151.sslip.io
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls:
     - secretName: jenkins-tls
       hosts:
         - jenkins.34.55.201.151.sslip.io

agent:
  enabled: true
  podTemplates:
    stackgen-runner: |
      - name: stackgen-runner
        label: stackgen
        serviceAccount: jenkins
        volumes:
          - name: google-cloud-key
            secret:
              secretName: gcp-sa-key
        containers:
          - name: stackgen
            image: ubuntu:22.04
            tty: true
            command:
              - "/bin/bash"
              - "-c"
              - |
                apt-get update && \
                apt-get install -y curl unzip git software-properties-common gnupg2 lsb-release && \
                curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add - && \
                apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main" && \
                apt-get update && apt-get install -y terraform && \
                cat
            env:
              - name: STACKGEN_API_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: stackgen-api-token
                    key: STACKGEN_API_TOKEN
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: /var/secrets/google/key.json
              - name: DEBIAN_FRONTEND
                value: noninteractive
            volumeMounts:
              - name: google-cloud-key
                mountPath: /var/secrets/google
                readOnly: true
