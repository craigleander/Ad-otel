controller:
  httpsKeyStore:
    enable: false
  ingress:
    enabled: true
    apiVersion: "networking.k8s.io/v1"
    hostName: jenkins.34.55.201.151.sslip.io
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls:
     - secretName: jenkins-tls
       hosts:
         - jenkins.34.55.201.151.sslip.io

agent:
  enabled: true
  podTemplates:
    stackgen-runner: |
      - name: stackgen-runner
        label: stackgen
        serviceAccount: jenkins
        volumes:
          - secretVolume:
              secretName: gcp-sa-key
              mountPath: /var/secrets/google
        containers:
          - name: stackgen
            image: ubuntu:22.04
            ttyEnabled: true
            command: |
              sh -c "
                # Create jenkins user if it doesn't exist
                if ! id -u jenkins > /dev/null 2>&1; then
                  useradd -m -u 1000 -s /bin/bash jenkins || true
                  mkdir -p /home/jenkins
                  chown -R jenkins:jenkins /home/jenkins || true
                  # Install sudo and configure it for jenkins user
                  apt-get update && apt-get install -y sudo || true
                  echo 'jenkins ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers || true
                fi
                # Switch to jenkins user and keep container running
                exec su - jenkins -c 'cat'
              "
            securityContext:
              runAsNonRoot: false
              allowPrivilegeEscalation: false
            envVars:
              - secretEnvVar:
                  key: STACKGEN_API_TOKEN
                  secretName: stackgen-api-token
                  secretKey: STACKGEN_API_TOKEN
              - envVar:
                  key: GOOGLE_APPLICATION_CREDENTIALS
                  value: /var/secrets/google/key.json
              - envVar:
                  key: DEBIAN_FRONTEND
                  value: noninteractive
